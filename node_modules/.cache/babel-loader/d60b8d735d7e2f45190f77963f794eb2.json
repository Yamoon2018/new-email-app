{"ast":null,"code":"var fs = require('fs'),\n    tls = require('tls'),\n    zlib = require('zlib'),\n    Socket = require('net').Socket,\n    EventEmitter = require('events').EventEmitter,\n    inherits = require('util').inherits,\n    inspect = require('util').inspect;\n\nvar Parser = require('./parser');\n\nvar XRegExp = require('xregexp').XRegExp;\n\nvar REX_TIMEVAL = XRegExp.cache('^(?<year>\\\\d{4})(?<month>\\\\d{2})(?<date>\\\\d{2})(?<hour>\\\\d{2})(?<minute>\\\\d{2})(?<second>\\\\d+)(?:.\\\\d+)?$'),\n    RE_PASV = /([\\d]+),([\\d]+),([\\d]+),([\\d]+),([-\\d]+),([-\\d]+)/,\n    RE_EOL = /\\r?\\n/g,\n    RE_WD = /\"(.+)\"(?: |$)/,\n    RE_SYST = /^([^ ]+)(?: |$)/;\nvar\n/*TYPE = {\n  SYNTAX: 0,\n  INFO: 1,\n  SOCKETS: 2,\n  AUTH: 3,\n  UNSPEC: 4,\n  FILESYS: 5\n},*/\nRETVAL = {\n  PRELIM: 1,\n  OK: 2,\n  WAITING: 3,\n  ERR_TEMP: 4,\n  ERR_PERM: 5\n},\n\n/*ERRORS = {\n  421: 'Service not available, closing control connection',\n  425: 'Can\\'t open data connection',\n  426: 'Connection closed; transfer aborted',\n  450: 'Requested file action not taken / File unavailable (e.g., file busy)',\n  451: 'Requested action aborted: local error in processing',\n  452: 'Requested action not taken / Insufficient storage space in system',\n  500: 'Syntax error / Command unrecognized',\n  501: 'Syntax error in parameters or arguments',\n  502: 'Command not implemented',\n  503: 'Bad sequence of commands',\n  504: 'Command not implemented for that parameter',\n  530: 'Not logged in',\n  532: 'Need account for storing files',\n  550: 'Requested action not taken / File unavailable (e.g., file not found, no access)',\n  551: 'Requested action aborted: page type unknown',\n  552: 'Requested file action aborted / Exceeded storage allocation (for current directory or dataset)',\n  553: 'Requested action not taken / File name not allowed'\n},*/\nbytesNOOP = new Buffer('NOOP\\r\\n');\n\nvar FTP = module.exports = function () {\n  if (!(this instanceof FTP)) return new FTP();\n  this._socket = undefined;\n  this._pasvSock = undefined;\n  this._feat = undefined;\n  this._curReq = undefined;\n  this._queue = [];\n  this._secstate = undefined;\n  this._debug = undefined;\n  this._keepalive = undefined;\n  this._ending = false;\n  this._parser = undefined;\n  this.options = {\n    host: undefined,\n    port: undefined,\n    user: undefined,\n    password: undefined,\n    secure: false,\n    secureOptions: undefined,\n    connTimeout: undefined,\n    pasvTimeout: undefined,\n    aliveTimeout: undefined\n  };\n  this.connected = false;\n};\n\ninherits(FTP, EventEmitter);\n\nFTP.prototype.connect = function (options) {\n  var self = this;\n  if (typeof options !== 'object') options = {};\n  this.connected = false;\n  this.options.host = options.host || 'localhost';\n  this.options.port = options.port || 21;\n  this.options.user = options.user || 'anonymous';\n  this.options.password = options.password || 'anonymous@';\n  this.options.secure = options.secure || false;\n  this.options.secureOptions = options.secureOptions;\n  this.options.connTimeout = options.connTimeout || 10000;\n  this.options.pasvTimeout = options.pasvTimeout || 10000;\n  this.options.aliveTimeout = options.keepalive || 10000;\n  if (typeof options.debug === 'function') this._debug = options.debug;\n  var secureOptions,\n      debug = this._debug,\n      socket = new Socket();\n  socket.setTimeout(0);\n  socket.setKeepAlive(true);\n  this._parser = new Parser({\n    debug: debug\n  });\n\n  this._parser.on('response', function (code, text) {\n    var retval = code / 100 >> 0;\n\n    if (retval === RETVAL.ERR_TEMP || retval === RETVAL.ERR_PERM) {\n      if (self._curReq) self._curReq.cb(makeError(code, text), undefined, code);else self.emit('error', makeError(code, text));\n    } else if (self._curReq) self._curReq.cb(undefined, text, code); // a hack to signal we're waiting for a PASV data connection to complete\n    // first before executing any more queued requests ...\n    //\n    // also: don't forget our current request if we're expecting another\n    // terminating response ....\n\n\n    if (self._curReq && retval !== RETVAL.PRELIM) {\n      self._curReq = undefined;\n\n      self._send();\n    }\n\n    noopreq.cb();\n  });\n\n  if (this.options.secure) {\n    secureOptions = {};\n    secureOptions.host = this.options.host;\n\n    for (var k in this.options.secureOptions) {\n      secureOptions[k] = this.options.secureOptions[k];\n    }\n\n    secureOptions.socket = socket;\n    this.options.secureOptions = secureOptions;\n  }\n\n  if (this.options.secure === 'implicit') this._socket = tls.connect(secureOptions, onconnect);else {\n    socket.once('connect', onconnect);\n    this._socket = socket;\n  }\n  var noopreq = {\n    cmd: 'NOOP',\n    cb: function cb() {\n      clearTimeout(self._keepalive);\n      self._keepalive = setTimeout(donoop, self.options.aliveTimeout);\n    }\n  };\n\n  function donoop() {\n    if (!self._socket || !self._socket.writable) clearTimeout(self._keepalive);else if (!self._curReq && self._queue.length === 0) {\n      self._curReq = noopreq;\n      debug && debug('[connection] > NOOP');\n\n      self._socket.write(bytesNOOP);\n    } else noopreq.cb();\n  }\n\n  function onconnect() {\n    clearTimeout(timer);\n    clearTimeout(self._keepalive);\n    self.connected = true;\n    self._socket = socket; // re-assign for implicit secure connections\n\n    var cmd;\n\n    if (self._secstate) {\n      if (self._secstate === 'upgraded-tls' && self.options.secure === true) {\n        cmd = 'PBSZ';\n\n        self._send('PBSZ 0', reentry, true);\n      } else {\n        cmd = 'USER';\n\n        self._send('USER ' + self.options.user, reentry, true);\n      }\n    } else {\n      self._curReq = {\n        cmd: '',\n        cb: reentry\n      };\n    }\n\n    function reentry(err, text, code) {\n      if (err && (!cmd || cmd === 'USER' || cmd === 'PASS' || cmd === 'TYPE')) {\n        self.emit('error', err);\n        return self._socket && self._socket.end();\n      }\n\n      if (cmd === 'AUTH TLS' && code !== 234 && self.options.secure !== true || cmd === 'AUTH SSL' && code !== 334 || cmd === 'PBSZ' && code !== 200 || cmd === 'PROT' && code !== 200) {\n        self.emit('error', makeError(code, 'Unable to secure connection(s)'));\n        return self._socket && self._socket.end();\n      }\n\n      if (!cmd) {\n        // sometimes the initial greeting can contain useful information\n        // about authorized use, other limits, etc.\n        self.emit('greeting', text);\n\n        if (self.options.secure && self.options.secure !== 'implicit') {\n          cmd = 'AUTH TLS';\n\n          self._send(cmd, reentry, true);\n        } else {\n          cmd = 'USER';\n\n          self._send('USER ' + self.options.user, reentry, true);\n        }\n      } else if (cmd === 'USER') {\n        if (code !== 230) {\n          // password required\n          if (!self.options.password) {\n            self.emit('error', makeError(code, 'Password required'));\n            return self._socket && self._socket.end();\n          }\n\n          cmd = 'PASS';\n\n          self._send('PASS ' + self.options.password, reentry, true);\n        } else {\n          // no password required\n          cmd = 'PASS';\n          reentry(undefined, text, code);\n        }\n      } else if (cmd === 'PASS') {\n        cmd = 'FEAT';\n\n        self._send(cmd, reentry, true);\n      } else if (cmd === 'FEAT') {\n        if (!err) self._feat = Parser.parseFeat(text);\n        cmd = 'TYPE';\n\n        self._send('TYPE I', reentry, true);\n      } else if (cmd === 'TYPE') self.emit('ready');else if (cmd === 'PBSZ') {\n        cmd = 'PROT';\n\n        self._send('PROT P', reentry, true);\n      } else if (cmd === 'PROT') {\n        cmd = 'USER';\n\n        self._send('USER ' + self.options.user, reentry, true);\n      } else if (cmd.substr(0, 4) === 'AUTH') {\n        if (cmd === 'AUTH TLS' && code !== 234) {\n          cmd = 'AUTH SSL';\n          return self._send(cmd, reentry, true);\n        } else if (cmd === 'AUTH TLS') self._secstate = 'upgraded-tls';else if (cmd === 'AUTH SSL') self._secstate = 'upgraded-ssl';\n\n        socket.removeAllListeners('data');\n        socket.removeAllListeners('error');\n        socket._decoder = null;\n        self._curReq = null; // prevent queue from being processed during\n        // TLS/SSL negotiation\n\n        secureOptions.socket = self._socket;\n        secureOptions.session = undefined;\n        socket = tls.connect(secureOptions, onconnect);\n        socket.setEncoding('binary');\n        socket.on('data', ondata);\n        socket.once('end', onend);\n        socket.on('error', onerror);\n      }\n    }\n  }\n\n  socket.on('data', ondata);\n\n  function ondata(chunk) {\n    debug && debug('[connection] < ' + inspect(chunk.toString('binary')));\n    if (self._parser) self._parser.write(chunk);\n  }\n\n  socket.on('error', onerror);\n\n  function onerror(err) {\n    clearTimeout(timer);\n    clearTimeout(self._keepalive);\n    self.emit('error', err);\n  }\n\n  socket.once('end', onend);\n\n  function onend() {\n    ondone();\n    self.emit('end');\n  }\n\n  socket.once('close', function (had_err) {\n    ondone();\n    self.emit('close', had_err);\n  });\n  var hasReset = false;\n\n  function ondone() {\n    if (!hasReset) {\n      hasReset = true;\n      clearTimeout(timer);\n\n      self._reset();\n    }\n  }\n\n  var timer = setTimeout(function () {\n    self.emit('error', new Error('Timeout while connecting to server'));\n    self._socket && self._socket.destroy();\n\n    self._reset();\n  }, this.options.connTimeout);\n\n  this._socket.connect(this.options.port, this.options.host);\n};\n\nFTP.prototype.end = function () {\n  if (this._queue.length) this._ending = true;else this._reset();\n};\n\nFTP.prototype.destroy = function () {\n  this._reset();\n}; // \"Standard\" (RFC 959) commands\n\n\nFTP.prototype.ascii = function (cb) {\n  return this._send('TYPE A', cb);\n};\n\nFTP.prototype.binary = function (cb) {\n  return this._send('TYPE I', cb);\n};\n\nFTP.prototype.abort = function (immediate, cb) {\n  if (typeof immediate === 'function') {\n    cb = immediate;\n    immediate = true;\n  }\n\n  if (immediate) this._send('ABOR', cb, true);else this._send('ABOR', cb);\n};\n\nFTP.prototype.cwd = function (path, cb, promote) {\n  this._send('CWD ' + path, function (err, text, code) {\n    if (err) return cb(err);\n    var m = RE_WD.exec(text);\n    cb(undefined, m ? m[1] : undefined);\n  }, promote);\n};\n\nFTP.prototype.delete = function (path, cb) {\n  this._send('DELE ' + path, cb);\n};\n\nFTP.prototype.site = function (cmd, cb) {\n  this._send('SITE ' + cmd, cb);\n};\n\nFTP.prototype.status = function (cb) {\n  this._send('STAT', cb);\n};\n\nFTP.prototype.rename = function (from, to, cb) {\n  var self = this;\n\n  this._send('RNFR ' + from, function (err) {\n    if (err) return cb(err);\n\n    self._send('RNTO ' + to, cb, true);\n  });\n};\n\nFTP.prototype.logout = function (cb) {\n  this._send('QUIT', cb);\n};\n\nFTP.prototype.listSafe = function (path, zcomp, cb) {\n  if (typeof path === 'string') {\n    var self = this; // store current path\n\n    this.pwd(function (err, origpath) {\n      if (err) return cb(err); // change to destination path\n\n      self.cwd(path, function (err) {\n        if (err) return cb(err); // get dir listing\n\n        self.list(zcomp || false, function (err, list) {\n          // change back to original path\n          if (err) return self.cwd(origpath, cb);\n          self.cwd(origpath, function (err) {\n            if (err) return cb(err);\n            cb(err, list);\n          });\n        });\n      });\n    });\n  } else this.list(path, zcomp, cb);\n};\n\nFTP.prototype.list = function (path, zcomp, cb) {\n  var self = this,\n      cmd;\n\n  if (typeof path === 'function') {\n    // list(function() {})\n    cb = path;\n    path = undefined;\n    cmd = 'LIST';\n    zcomp = false;\n  } else if (typeof path === 'boolean') {\n    // list(true, function() {})\n    cb = zcomp;\n    zcomp = path;\n    path = undefined;\n    cmd = 'LIST';\n  } else if (typeof zcomp === 'function') {\n    // list('/foo', function() {})\n    cb = zcomp;\n    cmd = 'LIST ' + path;\n    zcomp = false;\n  } else cmd = 'LIST ' + path;\n\n  this._pasv(function (err, sock) {\n    if (err) return cb(err);\n\n    if (self._queue[0] && self._queue[0].cmd === 'ABOR') {\n      sock.destroy();\n      return cb();\n    }\n\n    var sockerr,\n        done = false,\n        replies = 0,\n        entries,\n        buffer = '',\n        source = sock;\n\n    if (zcomp) {\n      source = zlib.createInflate();\n      sock.pipe(source);\n    }\n\n    source.on('data', function (chunk) {\n      buffer += chunk.toString('binary');\n    });\n    source.once('error', function (err) {\n      if (!sock.aborting) sockerr = err;\n    });\n    source.once('end', ondone);\n    source.once('close', ondone);\n\n    function ondone() {\n      done = true;\n      final();\n    }\n\n    function final() {\n      if (done && replies === 2) {\n        replies = 3;\n        if (sockerr) return cb(new Error('Unexpected data connection error: ' + sockerr));\n        if (sock.aborting) return cb(); // process received data\n\n        entries = buffer.split(RE_EOL);\n        entries.pop(); // ending EOL\n\n        var parsed = [];\n\n        for (var i = 0, len = entries.length; i < len; ++i) {\n          var parsedVal = Parser.parseListEntry(entries[i]);\n          if (parsedVal !== null) parsed.push(parsedVal);\n        }\n\n        if (zcomp) {\n          self._send('MODE S', function () {\n            cb(undefined, parsed);\n          }, true);\n        } else cb(undefined, parsed);\n      }\n    }\n\n    if (zcomp) {\n      self._send('MODE Z', function (err, text, code) {\n        if (err) {\n          sock.destroy();\n          return cb(makeError(code, 'Compression not supported'));\n        }\n\n        sendList();\n      }, true);\n    } else sendList();\n\n    function sendList() {\n      // this callback will be executed multiple times, the first is when server\n      // replies with 150 and then a final reply to indicate whether the\n      // transfer was actually a success or not\n      self._send(cmd, function (err, text, code) {\n        if (err) {\n          sock.destroy();\n\n          if (zcomp) {\n            self._send('MODE S', function () {\n              cb(err);\n            }, true);\n          } else cb(err);\n\n          return;\n        } // some servers may not open a data connection for empty directories\n\n\n        if (++replies === 1 && code === 226) {\n          replies = 2;\n          sock.destroy();\n          final();\n        } else if (replies === 2) final();\n      }, true);\n    }\n  });\n};\n\nFTP.prototype.get = function (path, zcomp, cb) {\n  var self = this;\n\n  if (typeof zcomp === 'function') {\n    cb = zcomp;\n    zcomp = false;\n  }\n\n  this._pasv(function (err, sock) {\n    if (err) return cb(err);\n\n    if (self._queue[0] && self._queue[0].cmd === 'ABOR') {\n      sock.destroy();\n      return cb();\n    } // modify behavior of socket events so that we can emit 'error' once for\n    // either a TCP-level error OR an FTP-level error response that we get when\n    // the socket is closed (e.g. the server ran out of space).\n\n\n    var sockerr,\n        started = false,\n        lastreply = false,\n        done = false,\n        source = sock;\n\n    if (zcomp) {\n      source = zlib.createInflate();\n      sock.pipe(source);\n      sock._emit = sock.emit;\n\n      sock.emit = function (ev, arg1) {\n        if (ev === 'error') {\n          if (!sockerr) sockerr = arg1;\n          return;\n        }\n\n        sock._emit.apply(sock, Array.prototype.slice.call(arguments));\n      };\n    }\n\n    source._emit = source.emit;\n\n    source.emit = function (ev, arg1) {\n      if (ev === 'error') {\n        if (!sockerr) sockerr = arg1;\n        return;\n      } else if (ev === 'end' || ev === 'close') {\n        if (!done) {\n          done = true;\n          ondone();\n        }\n\n        return;\n      }\n\n      source._emit.apply(source, Array.prototype.slice.call(arguments));\n    };\n\n    function ondone() {\n      if (done && lastreply) {\n        self._send('MODE S', function () {\n          source._emit('end');\n\n          source._emit('close');\n        }, true);\n      }\n    }\n\n    sock.pause();\n\n    if (zcomp) {\n      self._send('MODE Z', function (err, text, code) {\n        if (err) {\n          sock.destroy();\n          return cb(makeError(code, 'Compression not supported'));\n        }\n\n        sendRetr();\n      }, true);\n    } else sendRetr();\n\n    function sendRetr() {\n      // this callback will be executed multiple times, the first is when server\n      // replies with 150, then a final reply after the data connection closes\n      // to indicate whether the transfer was actually a success or not\n      self._send('RETR ' + path, function (err, text, code) {\n        if (sockerr || err) {\n          sock.destroy();\n\n          if (!started) {\n            if (zcomp) {\n              self._send('MODE S', function () {\n                cb(sockerr || err);\n              }, true);\n            } else cb(sockerr || err);\n          } else {\n            source._emit('error', sockerr || err);\n\n            source._emit('close', true);\n          }\n\n          return;\n        } // server returns 125 when data connection is already open; we treat it\n        // just like a 150\n\n\n        if (code === 150 || code === 125) {\n          started = true;\n          cb(undefined, source);\n          sock.resume();\n        } else {\n          lastreply = true;\n          ondone();\n        }\n      }, true);\n    }\n  });\n};\n\nFTP.prototype.put = function (input, path, zcomp, cb) {\n  this._store('STOR ' + path, input, zcomp, cb);\n};\n\nFTP.prototype.append = function (input, path, zcomp, cb) {\n  this._store('APPE ' + path, input, zcomp, cb);\n};\n\nFTP.prototype.pwd = function (cb) {\n  // PWD is optional\n  var self = this;\n\n  this._send('PWD', function (err, text, code) {\n    if (code === 502) {\n      return self.cwd('.', function (cwderr, cwd) {\n        if (cwderr) return cb(cwderr);\n        if (cwd === undefined) cb(err);else cb(undefined, cwd);\n      }, true);\n    } else if (err) return cb(err);\n\n    cb(undefined, RE_WD.exec(text)[1]);\n  });\n};\n\nFTP.prototype.cdup = function (cb) {\n  // CDUP is optional\n  var self = this;\n\n  this._send('CDUP', function (err, text, code) {\n    if (code === 502) self.cwd('..', cb, true);else cb(err);\n  });\n};\n\nFTP.prototype.mkdir = function (path, recursive, cb) {\n  // MKD is optional\n  if (typeof recursive === 'function') {\n    cb = recursive;\n    recursive = false;\n  }\n\n  if (!recursive) this._send('MKD ' + path, cb);else {\n    var self = this,\n        owd,\n        abs,\n        dirs,\n        dirslen,\n        i = -1,\n        searching = true;\n    abs = path[0] === '/';\n\n    var nextDir = function nextDir() {\n      if (++i === dirslen) {\n        // return to original working directory\n        return self._send('CWD ' + owd, cb, true);\n      }\n\n      if (searching) {\n        self._send('CWD ' + dirs[i], function (err, text, code) {\n          if (code === 550) {\n            searching = false;\n            --i;\n          } else if (err) {\n            // return to original working directory\n            return self._send('CWD ' + owd, function () {\n              cb(err);\n            }, true);\n          }\n\n          nextDir();\n        }, true);\n      } else {\n        self._send('MKD ' + dirs[i], function (err, text, code) {\n          if (err) {\n            // return to original working directory\n            return self._send('CWD ' + owd, function () {\n              cb(err);\n            }, true);\n          }\n\n          self._send('CWD ' + dirs[i], nextDir, true);\n        }, true);\n      }\n    };\n\n    this.pwd(function (err, cwd) {\n      if (err) return cb(err);\n      owd = cwd;\n      if (abs) path = path.substr(1);\n      if (path[path.length - 1] === '/') path = path.substring(0, path.length - 1);\n      dirs = path.split('/');\n      dirslen = dirs.length;\n      if (abs) self._send('CWD /', function (err) {\n        if (err) return cb(err);\n        nextDir();\n      }, true);else nextDir();\n    });\n  }\n};\n\nFTP.prototype.rmdir = function (path, recursive, cb) {\n  // RMD is optional\n  if (typeof recursive === 'function') {\n    cb = recursive;\n    recursive = false;\n  }\n\n  if (!recursive) {\n    return this._send('RMD ' + path, cb);\n  }\n\n  var self = this;\n  this.list(path, function (err, list) {\n    if (err) return cb(err);\n    var idx = 0; // this function will be called once per listing entry\n\n    var _deleteNextEntry;\n\n    _deleteNextEntry = function deleteNextEntry(err) {\n      if (err) return cb(err);\n\n      if (idx >= list.length) {\n        if (list[0] && list[0].name === path) {\n          return cb(null);\n        } else {\n          return self.rmdir(path, cb);\n        }\n      }\n\n      var entry = list[idx++]; // get the path to the file\n\n      var subpath = null;\n\n      if (entry.name[0] === '/') {\n        // this will be the case when you call deleteRecursively() and pass\n        // the path to a plain file\n        subpath = entry.name;\n      } else {\n        if (path[path.length - 1] == '/') {\n          subpath = path + entry.name;\n        } else {\n          subpath = path + '/' + entry.name;\n        }\n      } // delete the entry (recursively) according to its type\n\n\n      if (entry.type === 'd') {\n        if (entry.name === \".\" || entry.name === \"..\") {\n          return _deleteNextEntry();\n        }\n\n        self.rmdir(subpath, true, _deleteNextEntry);\n      } else {\n        self.delete(subpath, _deleteNextEntry);\n      }\n    };\n\n    _deleteNextEntry();\n  });\n};\n\nFTP.prototype.system = function (cb) {\n  // SYST is optional\n  this._send('SYST', function (err, text) {\n    if (err) return cb(err);\n    cb(undefined, RE_SYST.exec(text)[1]);\n  });\n}; // \"Extended\" (RFC 3659) commands\n\n\nFTP.prototype.size = function (path, cb) {\n  var self = this;\n\n  this._send('SIZE ' + path, function (err, text, code) {\n    if (code === 502) {\n      // Note: this may cause a problem as list() is _appended_ to the queue\n      return self.list(path, function (err, list) {\n        if (err) return cb(err);\n        if (list.length === 1) cb(undefined, list[0].size);else {\n          // path could have been a directory and we got a listing of its\n          // contents, but here we echo the behavior of the real SIZE and\n          // return 'File not found' for directories\n          cb(new Error('File not found'));\n        }\n      }, true);\n    } else if (err) return cb(err);\n\n    cb(undefined, parseInt(text, 10));\n  });\n};\n\nFTP.prototype.lastMod = function (path, cb) {\n  var self = this;\n\n  this._send('MDTM ' + path, function (err, text, code) {\n    if (code === 502) {\n      return self.list(path, function (err, list) {\n        if (err) return cb(err);\n        if (list.length === 1) cb(undefined, list[0].date);else cb(new Error('File not found'));\n      }, true);\n    } else if (err) return cb(err);\n\n    var val = XRegExp.exec(text, REX_TIMEVAL),\n        ret;\n    if (!val) return cb(new Error('Invalid date/time format from server'));\n    ret = new Date(val.year + '-' + val.month + '-' + val.date + 'T' + val.hour + ':' + val.minute + ':' + val.second);\n    cb(undefined, ret);\n  });\n};\n\nFTP.prototype.restart = function (offset, cb) {\n  this._send('REST ' + offset, cb);\n}; // Private/Internal methods\n\n\nFTP.prototype._pasv = function (cb) {\n  var self = this,\n      first = true,\n      ip,\n      port;\n\n  this._send('PASV', function reentry(err, text) {\n    if (err) return cb(err);\n    self._curReq = undefined;\n\n    if (first) {\n      var m = RE_PASV.exec(text);\n      if (!m) return cb(new Error('Unable to parse PASV server response'));\n      ip = m[1];\n      ip += '.';\n      ip += m[2];\n      ip += '.';\n      ip += m[3];\n      ip += '.';\n      ip += m[4];\n      port = parseInt(m[5], 10) * 256 + parseInt(m[6], 10);\n      first = false;\n    }\n\n    self._pasvConnect(ip, port, function (err, sock) {\n      if (err) {\n        // try the IP of the control connection if the server was somehow\n        // misconfigured and gave for example a LAN IP instead of WAN IP over\n        // the Internet\n        if (self._socket && ip !== self._socket.remoteAddress) {\n          ip = self._socket.remoteAddress;\n          return reentry();\n        } // automatically abort PASV mode\n\n\n        self._send('ABOR', function () {\n          cb(err);\n\n          self._send();\n        }, true);\n\n        return;\n      }\n\n      cb(undefined, sock);\n\n      self._send();\n    });\n  });\n};\n\nFTP.prototype._pasvConnect = function (ip, port, cb) {\n  var self = this,\n      socket = new Socket(),\n      sockerr,\n      timedOut = false,\n      timer = setTimeout(function () {\n    timedOut = true;\n    socket.destroy();\n    cb(new Error('Timed out while making data connection'));\n  }, this.options.pasvTimeout);\n  socket.setTimeout(0);\n  socket.once('connect', function () {\n    self._debug && self._debug('[connection] PASV socket connected');\n\n    if (self.options.secure === true) {\n      self.options.secureOptions.socket = socket;\n      self.options.secureOptions.session = self._socket.getSession(); //socket.removeAllListeners('error');\n\n      socket = tls.connect(self.options.secureOptions); //socket.once('error', onerror);\n\n      socket.setTimeout(0);\n    }\n\n    clearTimeout(timer);\n    self._pasvSocket = socket;\n    cb(undefined, socket);\n  });\n  socket.once('error', onerror);\n\n  function onerror(err) {\n    sockerr = err;\n  }\n\n  socket.once('end', function () {\n    clearTimeout(timer);\n  });\n  socket.once('close', function (had_err) {\n    clearTimeout(timer);\n\n    if (!self._pasvSocket && !timedOut) {\n      var errmsg = 'Unable to make data connection';\n\n      if (sockerr) {\n        errmsg += '( ' + sockerr + ')';\n        sockerr = undefined;\n      }\n\n      cb(new Error(errmsg));\n    }\n\n    self._pasvSocket = undefined;\n  });\n  socket.connect(port, ip);\n};\n\nFTP.prototype._store = function (cmd, input, zcomp, cb) {\n  var isBuffer = Buffer.isBuffer(input);\n  if (!isBuffer && input.pause !== undefined) input.pause();\n\n  if (typeof zcomp === 'function') {\n    cb = zcomp;\n    zcomp = false;\n  }\n\n  var self = this;\n\n  this._pasv(function (err, sock) {\n    if (err) return cb(err);\n\n    if (self._queue[0] && self._queue[0].cmd === 'ABOR') {\n      sock.destroy();\n      return cb();\n    }\n\n    var sockerr,\n        dest = sock;\n    sock.once('error', function (err) {\n      sockerr = err;\n    });\n\n    if (zcomp) {\n      self._send('MODE Z', function (err, text, code) {\n        if (err) {\n          sock.destroy();\n          return cb(makeError(code, 'Compression not supported'));\n        } // draft-preston-ftpext-deflate-04 says min of 8 should be supported\n\n\n        dest = zlib.createDeflate({\n          level: 8\n        });\n        dest.pipe(sock);\n        sendStore();\n      }, true);\n    } else sendStore();\n\n    function sendStore() {\n      // this callback will be executed multiple times, the first is when server\n      // replies with 150, then a final reply after the data connection closes\n      // to indicate whether the transfer was actually a success or not\n      self._send(cmd, function (err, text, code) {\n        if (sockerr || err) {\n          if (zcomp) {\n            self._send('MODE S', function () {\n              cb(sockerr || err);\n            }, true);\n          } else cb(sockerr || err);\n\n          return;\n        }\n\n        if (code === 150 || code === 125) {\n          if (isBuffer) dest.end(input);else if (typeof input === 'string') {\n            // check if input is a file path or just string data to store\n            fs.stat(input, function (err, stats) {\n              if (err) dest.end(input);else fs.createReadStream(input).pipe(dest);\n            });\n          } else {\n            input.pipe(dest);\n            input.resume();\n          }\n        } else {\n          if (zcomp) self._send('MODE S', cb, true);else cb();\n        }\n      }, true);\n    }\n  });\n};\n\nFTP.prototype._send = function (cmd, cb, promote) {\n  clearTimeout(this._keepalive);\n\n  if (cmd !== undefined) {\n    if (promote) this._queue.unshift({\n      cmd: cmd,\n      cb: cb\n    });else this._queue.push({\n      cmd: cmd,\n      cb: cb\n    });\n  }\n\n  var queueLen = this._queue.length;\n\n  if (!this._curReq && queueLen && this._socket && this._socket.readable) {\n    this._curReq = this._queue.shift();\n    if (this._curReq.cmd === 'ABOR' && this._pasvSocket) this._pasvSocket.aborting = true;\n    this._debug && this._debug('[connection] > ' + inspect(this._curReq.cmd));\n\n    this._socket.write(this._curReq.cmd + '\\r\\n');\n  } else if (!this._curReq && !queueLen && this._ending) this._reset();\n};\n\nFTP.prototype._reset = function () {\n  if (this._pasvSock && this._pasvSock.writable) this._pasvSock.end();\n  if (this._socket && this._socket.writable) this._socket.end();\n  this._socket = undefined;\n  this._pasvSock = undefined;\n  this._feat = undefined;\n  this._curReq = undefined;\n  this._secstate = undefined;\n  clearTimeout(this._keepalive);\n  this._keepalive = undefined;\n  this._queue = [];\n  this._ending = false;\n  this._parser = undefined;\n  this.options.host = this.options.port = this.options.user = this.options.password = this.options.secure = this.options.connTimeout = this.options.pasvTimeout = this.options.keepalive = this._debug = undefined;\n  this.connected = false;\n}; // Utility functions\n\n\nfunction makeError(code, text) {\n  var err = new Error(text);\n  err.code = code;\n  return err;\n}","map":{"version":3,"sources":["/home/yamin/My_repos/new-email-app/new-email-app/node_modules/ftp/lib/connection.js"],"names":["fs","require","tls","zlib","Socket","EventEmitter","inherits","inspect","Parser","XRegExp","REX_TIMEVAL","cache","RE_PASV","RE_EOL","RE_WD","RE_SYST","RETVAL","PRELIM","OK","WAITING","ERR_TEMP","ERR_PERM","bytesNOOP","Buffer","FTP","module","exports","_socket","undefined","_pasvSock","_feat","_curReq","_queue","_secstate","_debug","_keepalive","_ending","_parser","options","host","port","user","password","secure","secureOptions","connTimeout","pasvTimeout","aliveTimeout","connected","prototype","connect","self","keepalive","debug","socket","setTimeout","setKeepAlive","on","code","text","retval","cb","makeError","emit","_send","noopreq","k","onconnect","once","cmd","clearTimeout","donoop","writable","length","write","timer","reentry","err","end","parseFeat","substr","removeAllListeners","_decoder","session","setEncoding","ondata","onend","onerror","chunk","toString","ondone","had_err","hasReset","_reset","Error","destroy","ascii","binary","abort","immediate","cwd","path","promote","m","exec","delete","site","status","rename","from","to","logout","listSafe","zcomp","pwd","origpath","list","_pasv","sock","sockerr","done","replies","entries","buffer","source","createInflate","pipe","aborting","final","split","pop","parsed","i","len","parsedVal","parseListEntry","push","sendList","get","started","lastreply","_emit","ev","arg1","apply","Array","slice","call","arguments","pause","sendRetr","resume","put","input","_store","append","cwderr","cdup","mkdir","recursive","owd","abs","dirs","dirslen","searching","nextDir","substring","rmdir","idx","deleteNextEntry","name","entry","subpath","type","system","size","parseInt","lastMod","date","val","ret","Date","year","month","hour","minute","second","restart","offset","first","ip","_pasvConnect","remoteAddress","timedOut","getSession","_pasvSocket","errmsg","isBuffer","dest","createDeflate","level","sendStore","stat","stats","createReadStream","unshift","queueLen","readable","shift"],"mappings":"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","sourcesContent":["var fs = require('fs'),\n    tls = require('tls'),\n    zlib = require('zlib'),\n    Socket = require('net').Socket,\n    EventEmitter = require('events').EventEmitter,\n    inherits = require('util').inherits,\n    inspect = require('util').inspect;\n\nvar Parser = require('./parser');\nvar XRegExp = require('xregexp').XRegExp;\n\nvar REX_TIMEVAL = XRegExp.cache('^(?<year>\\\\d{4})(?<month>\\\\d{2})(?<date>\\\\d{2})(?<hour>\\\\d{2})(?<minute>\\\\d{2})(?<second>\\\\d+)(?:.\\\\d+)?$'),\n    RE_PASV = /([\\d]+),([\\d]+),([\\d]+),([\\d]+),([-\\d]+),([-\\d]+)/,\n    RE_EOL = /\\r?\\n/g,\n    RE_WD = /\"(.+)\"(?: |$)/,\n    RE_SYST = /^([^ ]+)(?: |$)/;\n\nvar /*TYPE = {\n      SYNTAX: 0,\n      INFO: 1,\n      SOCKETS: 2,\n      AUTH: 3,\n      UNSPEC: 4,\n      FILESYS: 5\n    },*/\n    RETVAL = {\n      PRELIM: 1,\n      OK: 2,\n      WAITING: 3,\n      ERR_TEMP: 4,\n      ERR_PERM: 5\n    },\n    /*ERRORS = {\n      421: 'Service not available, closing control connection',\n      425: 'Can\\'t open data connection',\n      426: 'Connection closed; transfer aborted',\n      450: 'Requested file action not taken / File unavailable (e.g., file busy)',\n      451: 'Requested action aborted: local error in processing',\n      452: 'Requested action not taken / Insufficient storage space in system',\n      500: 'Syntax error / Command unrecognized',\n      501: 'Syntax error in parameters or arguments',\n      502: 'Command not implemented',\n      503: 'Bad sequence of commands',\n      504: 'Command not implemented for that parameter',\n      530: 'Not logged in',\n      532: 'Need account for storing files',\n      550: 'Requested action not taken / File unavailable (e.g., file not found, no access)',\n      551: 'Requested action aborted: page type unknown',\n      552: 'Requested file action aborted / Exceeded storage allocation (for current directory or dataset)',\n      553: 'Requested action not taken / File name not allowed'\n    },*/\n    bytesNOOP = new Buffer('NOOP\\r\\n');\n\nvar FTP = module.exports = function() {\n  if (!(this instanceof FTP))\n    return new FTP();\n\n  this._socket = undefined;\n  this._pasvSock = undefined;\n  this._feat = undefined;\n  this._curReq = undefined;\n  this._queue = [];\n  this._secstate = undefined;\n  this._debug = undefined;\n  this._keepalive = undefined;\n  this._ending = false;\n  this._parser = undefined;\n  this.options = {\n    host: undefined,\n    port: undefined,\n    user: undefined,\n    password: undefined,\n    secure: false,\n    secureOptions: undefined,\n    connTimeout: undefined,\n    pasvTimeout: undefined,\n    aliveTimeout: undefined\n  };\n  this.connected = false;\n};\ninherits(FTP, EventEmitter);\n\nFTP.prototype.connect = function(options) {\n  var self = this;\n  if (typeof options !== 'object')\n    options = {};\n  this.connected = false;\n  this.options.host = options.host || 'localhost';\n  this.options.port = options.port || 21;\n  this.options.user = options.user || 'anonymous';\n  this.options.password = options.password || 'anonymous@';\n  this.options.secure = options.secure || false;\n  this.options.secureOptions = options.secureOptions;\n  this.options.connTimeout = options.connTimeout || 10000;\n  this.options.pasvTimeout = options.pasvTimeout || 10000;\n  this.options.aliveTimeout = options.keepalive || 10000;\n\n  if (typeof options.debug === 'function')\n    this._debug = options.debug;\n\n  var secureOptions,\n      debug = this._debug,\n      socket = new Socket();\n\n  socket.setTimeout(0);\n  socket.setKeepAlive(true);\n\n  this._parser = new Parser({ debug: debug });\n  this._parser.on('response', function(code, text) {\n    var retval = code / 100 >> 0;\n    if (retval === RETVAL.ERR_TEMP || retval === RETVAL.ERR_PERM) {\n      if (self._curReq)\n        self._curReq.cb(makeError(code, text), undefined, code);\n      else\n        self.emit('error', makeError(code, text));\n    } else if (self._curReq)\n      self._curReq.cb(undefined, text, code);\n\n    // a hack to signal we're waiting for a PASV data connection to complete\n    // first before executing any more queued requests ...\n    //\n    // also: don't forget our current request if we're expecting another\n    // terminating response ....\n    if (self._curReq && retval !== RETVAL.PRELIM) {\n      self._curReq = undefined;\n      self._send();\n    }\n\n    noopreq.cb();\n  });\n\n  if (this.options.secure) {\n    secureOptions = {};\n    secureOptions.host = this.options.host;\n    for (var k in this.options.secureOptions)\n      secureOptions[k] = this.options.secureOptions[k];\n    secureOptions.socket = socket;\n    this.options.secureOptions = secureOptions;\n  }\n\n  if (this.options.secure === 'implicit')\n    this._socket = tls.connect(secureOptions, onconnect);\n  else {\n    socket.once('connect', onconnect);\n    this._socket = socket;\n  }\n\n  var noopreq = {\n        cmd: 'NOOP',\n        cb: function() {\n          clearTimeout(self._keepalive);\n          self._keepalive = setTimeout(donoop, self.options.aliveTimeout);\n        }\n      };\n\n  function donoop() {\n    if (!self._socket || !self._socket.writable)\n      clearTimeout(self._keepalive);\n    else if (!self._curReq && self._queue.length === 0) {\n      self._curReq = noopreq;\n      debug&&debug('[connection] > NOOP');\n      self._socket.write(bytesNOOP);\n    } else\n      noopreq.cb();\n  }\n\n  function onconnect() {\n    clearTimeout(timer);\n    clearTimeout(self._keepalive);\n    self.connected = true;\n    self._socket = socket; // re-assign for implicit secure connections\n\n    var cmd;\n\n    if (self._secstate) {\n      if (self._secstate === 'upgraded-tls' && self.options.secure === true) {\n        cmd = 'PBSZ';\n        self._send('PBSZ 0', reentry, true);\n      } else {\n        cmd = 'USER';\n        self._send('USER ' + self.options.user, reentry, true);\n      }\n    } else {\n      self._curReq = {\n        cmd: '',\n        cb: reentry\n      };\n    }\n\n    function reentry(err, text, code) {\n      if (err && (!cmd || cmd === 'USER' || cmd === 'PASS' || cmd === 'TYPE')) {\n        self.emit('error', err);\n        return self._socket && self._socket.end();\n      }\n      if ((cmd === 'AUTH TLS' && code !== 234 && self.options.secure !== true)\n          || (cmd === 'AUTH SSL' && code !== 334)\n          || (cmd === 'PBSZ' && code !== 200)\n          || (cmd === 'PROT' && code !== 200)) {\n        self.emit('error', makeError(code, 'Unable to secure connection(s)'));\n        return self._socket && self._socket.end();\n      }\n\n      if (!cmd) {\n        // sometimes the initial greeting can contain useful information\n        // about authorized use, other limits, etc.\n        self.emit('greeting', text);\n\n        if (self.options.secure && self.options.secure !== 'implicit') {\n          cmd = 'AUTH TLS';\n          self._send(cmd, reentry, true);\n        } else {\n          cmd = 'USER';\n          self._send('USER ' + self.options.user, reentry, true);\n        }\n      } else if (cmd === 'USER') {\n        if (code !== 230) {\n          // password required\n          if (!self.options.password) {\n            self.emit('error', makeError(code, 'Password required'));\n            return self._socket && self._socket.end();\n          }\n          cmd = 'PASS';\n          self._send('PASS ' + self.options.password, reentry, true);\n        } else {\n          // no password required\n          cmd = 'PASS';\n          reentry(undefined, text, code);\n        }\n      } else if (cmd === 'PASS') {\n        cmd = 'FEAT';\n        self._send(cmd, reentry, true);\n      } else if (cmd === 'FEAT') {\n        if (!err)\n          self._feat = Parser.parseFeat(text);\n        cmd = 'TYPE';\n        self._send('TYPE I', reentry, true);\n      } else if (cmd === 'TYPE')\n        self.emit('ready');\n      else if (cmd === 'PBSZ') {\n        cmd = 'PROT';\n        self._send('PROT P', reentry, true);\n      } else if (cmd === 'PROT') {\n        cmd = 'USER';\n        self._send('USER ' + self.options.user, reentry, true);\n      } else if (cmd.substr(0, 4) === 'AUTH') {\n        if (cmd === 'AUTH TLS' && code !== 234) {\n          cmd = 'AUTH SSL';\n          return self._send(cmd, reentry, true);\n        } else if (cmd === 'AUTH TLS')\n          self._secstate = 'upgraded-tls';\n        else if (cmd === 'AUTH SSL')\n          self._secstate = 'upgraded-ssl';\n        socket.removeAllListeners('data');\n        socket.removeAllListeners('error');\n        socket._decoder = null;\n        self._curReq = null; // prevent queue from being processed during\n                             // TLS/SSL negotiation\n        secureOptions.socket = self._socket;\n        secureOptions.session = undefined;\n        socket = tls.connect(secureOptions, onconnect);\n        socket.setEncoding('binary');\n        socket.on('data', ondata);\n        socket.once('end', onend);\n        socket.on('error', onerror);\n      }\n    }\n  }\n\n  socket.on('data', ondata);\n  function ondata(chunk) {\n    debug&&debug('[connection] < ' + inspect(chunk.toString('binary')));\n    if (self._parser)\n      self._parser.write(chunk);\n  }\n\n  socket.on('error', onerror);\n  function onerror(err) {\n    clearTimeout(timer);\n    clearTimeout(self._keepalive);\n    self.emit('error', err);\n  }\n\n  socket.once('end', onend);\n  function onend() {\n    ondone();\n    self.emit('end');\n  }\n\n  socket.once('close', function(had_err) {\n    ondone();\n    self.emit('close', had_err);\n  });\n\n  var hasReset = false;\n  function ondone() {\n    if (!hasReset) {\n      hasReset = true;\n      clearTimeout(timer);\n      self._reset();\n    }\n  }\n\n  var timer = setTimeout(function() {\n    self.emit('error', new Error('Timeout while connecting to server'));\n    self._socket && self._socket.destroy();\n    self._reset();\n  }, this.options.connTimeout);\n\n  this._socket.connect(this.options.port, this.options.host);\n};\n\nFTP.prototype.end = function() {\n  if (this._queue.length)\n    this._ending = true;\n  else\n    this._reset();\n};\n\nFTP.prototype.destroy = function() {\n  this._reset();\n};\n\n// \"Standard\" (RFC 959) commands\nFTP.prototype.ascii = function(cb) {\n  return this._send('TYPE A', cb);\n};\n\nFTP.prototype.binary = function(cb) {\n  return this._send('TYPE I', cb);\n};\n\nFTP.prototype.abort = function(immediate, cb) {\n  if (typeof immediate === 'function') {\n    cb = immediate;\n    immediate = true;\n  }\n  if (immediate)\n    this._send('ABOR', cb, true);\n  else\n    this._send('ABOR', cb);\n};\n\nFTP.prototype.cwd = function(path, cb, promote) {\n  this._send('CWD ' + path, function(err, text, code) {\n    if (err)\n      return cb(err);\n    var m = RE_WD.exec(text);\n    cb(undefined, m ? m[1] : undefined);\n  }, promote);\n};\n\nFTP.prototype.delete = function(path, cb) {\n  this._send('DELE ' + path, cb);\n};\n\nFTP.prototype.site = function(cmd, cb) {\n  this._send('SITE ' + cmd, cb);\n};\n\nFTP.prototype.status = function(cb) {\n  this._send('STAT', cb);\n};\n\nFTP.prototype.rename = function(from, to, cb) {\n  var self = this;\n  this._send('RNFR ' + from, function(err) {\n    if (err)\n      return cb(err);\n\n    self._send('RNTO ' + to, cb, true);\n  });\n};\n\nFTP.prototype.logout = function(cb) {\n  this._send('QUIT', cb);\n};\n\nFTP.prototype.listSafe = function(path, zcomp, cb) {\n  if (typeof path === 'string') {\n    var self = this;\n    // store current path\n    this.pwd(function(err, origpath) {\n      if (err) return cb(err);\n      // change to destination path\n      self.cwd(path, function(err) {\n        if (err) return cb(err);\n        // get dir listing\n        self.list(zcomp || false, function(err, list) {\n          // change back to original path\n          if (err) return self.cwd(origpath, cb);\n          self.cwd(origpath, function(err) {\n            if (err) return cb(err);\n            cb(err, list);\n          });\n        });\n      });\n    });\n  } else\n    this.list(path, zcomp, cb);\n};\n\nFTP.prototype.list = function(path, zcomp, cb) {\n  var self = this, cmd;\n\n  if (typeof path === 'function') {\n    // list(function() {})\n    cb = path;\n    path = undefined;\n    cmd = 'LIST';\n    zcomp = false;\n  } else if (typeof path === 'boolean') {\n    // list(true, function() {})\n    cb = zcomp;\n    zcomp = path;\n    path = undefined;\n    cmd = 'LIST';\n  } else if (typeof zcomp === 'function') {\n    // list('/foo', function() {})\n    cb = zcomp;\n    cmd = 'LIST ' + path;\n    zcomp = false;\n  } else\n    cmd = 'LIST ' + path;\n\n  this._pasv(function(err, sock) {\n    if (err)\n      return cb(err);\n\n    if (self._queue[0] && self._queue[0].cmd === 'ABOR') {\n      sock.destroy();\n      return cb();\n    }\n\n    var sockerr, done = false, replies = 0, entries, buffer = '', source = sock;\n\n    if (zcomp) {\n      source = zlib.createInflate();\n      sock.pipe(source);\n    }\n\n    source.on('data', function(chunk) { buffer += chunk.toString('binary'); });\n    source.once('error', function(err) {\n      if (!sock.aborting)\n        sockerr = err;\n    });\n    source.once('end', ondone);\n    source.once('close', ondone);\n\n    function ondone() {\n      done = true;\n      final();\n    }\n    function final() {\n      if (done && replies === 2) {\n        replies = 3;\n        if (sockerr)\n          return cb(new Error('Unexpected data connection error: ' + sockerr));\n        if (sock.aborting)\n          return cb();\n\n        // process received data\n        entries = buffer.split(RE_EOL);\n        entries.pop(); // ending EOL\n        var parsed = [];\n        for (var i = 0, len = entries.length; i < len; ++i) {\n          var parsedVal = Parser.parseListEntry(entries[i]);\n          if (parsedVal !== null)\n            parsed.push(parsedVal);\n        }\n\n        if (zcomp) {\n          self._send('MODE S', function() {\n            cb(undefined, parsed);\n          }, true);\n        } else\n          cb(undefined, parsed);\n      }\n    }\n\n    if (zcomp) {\n      self._send('MODE Z', function(err, text, code) {\n        if (err) {\n          sock.destroy();\n          return cb(makeError(code, 'Compression not supported'));\n        }\n        sendList();\n      }, true);\n    } else\n      sendList();\n\n    function sendList() {\n      // this callback will be executed multiple times, the first is when server\n      // replies with 150 and then a final reply to indicate whether the\n      // transfer was actually a success or not\n      self._send(cmd, function(err, text, code) {\n        if (err) {\n          sock.destroy();\n          if (zcomp) {\n            self._send('MODE S', function() {\n              cb(err);\n            }, true);\n          } else\n            cb(err);\n          return;\n        }\n\n        // some servers may not open a data connection for empty directories\n        if (++replies === 1 && code === 226) {\n          replies = 2;\n          sock.destroy();\n          final();\n        } else if (replies === 2)\n          final();\n      }, true);\n    }\n  });\n};\n\nFTP.prototype.get = function(path, zcomp, cb) {\n  var self = this;\n  if (typeof zcomp === 'function') {\n    cb = zcomp;\n    zcomp = false;\n  }\n\n  this._pasv(function(err, sock) {\n    if (err)\n      return cb(err);\n\n    if (self._queue[0] && self._queue[0].cmd === 'ABOR') {\n      sock.destroy();\n      return cb();\n    }\n\n    // modify behavior of socket events so that we can emit 'error' once for\n    // either a TCP-level error OR an FTP-level error response that we get when\n    // the socket is closed (e.g. the server ran out of space).\n    var sockerr, started = false, lastreply = false, done = false,\n        source = sock;\n\n    if (zcomp) {\n      source = zlib.createInflate();\n      sock.pipe(source);\n      sock._emit = sock.emit;\n      sock.emit = function(ev, arg1) {\n        if (ev === 'error') {\n          if (!sockerr)\n            sockerr = arg1;\n          return;\n        }\n        sock._emit.apply(sock, Array.prototype.slice.call(arguments));\n      };\n    }\n\n    source._emit = source.emit;\n    source.emit = function(ev, arg1) {\n      if (ev === 'error') {\n        if (!sockerr)\n          sockerr = arg1;\n        return;\n      } else if (ev === 'end' || ev === 'close') {\n        if (!done) {\n          done = true;\n          ondone();\n        }\n        return;\n      }\n      source._emit.apply(source, Array.prototype.slice.call(arguments));\n    };\n\n    function ondone() {\n      if (done && lastreply) {\n        self._send('MODE S', function() {\n          source._emit('end');\n          source._emit('close');\n        }, true);\n      }\n    }\n\n    sock.pause();\n\n    if (zcomp) {\n      self._send('MODE Z', function(err, text, code) {\n        if (err) {\n          sock.destroy();\n          return cb(makeError(code, 'Compression not supported'));\n        }\n        sendRetr();\n      }, true);\n    } else\n      sendRetr();\n\n    function sendRetr() {\n      // this callback will be executed multiple times, the first is when server\n      // replies with 150, then a final reply after the data connection closes\n      // to indicate whether the transfer was actually a success or not\n      self._send('RETR ' + path, function(err, text, code) {\n        if (sockerr || err) {\n          sock.destroy();\n          if (!started) {\n            if (zcomp) {\n              self._send('MODE S', function() {\n                cb(sockerr || err);\n              }, true);\n            } else\n              cb(sockerr || err);\n          } else {\n            source._emit('error', sockerr || err);\n            source._emit('close', true);\n          }\n          return;\n        }\n        // server returns 125 when data connection is already open; we treat it\n        // just like a 150\n        if (code === 150 || code === 125) {\n          started = true;\n          cb(undefined, source);\n          sock.resume();\n        } else {\n          lastreply = true;\n          ondone();\n        }\n      }, true);\n    }\n  });\n};\n\nFTP.prototype.put = function(input, path, zcomp, cb) {\n  this._store('STOR ' + path, input, zcomp, cb);\n};\n\nFTP.prototype.append = function(input, path, zcomp, cb) {\n  this._store('APPE ' + path, input, zcomp, cb);\n};\n\nFTP.prototype.pwd = function(cb) { // PWD is optional\n  var self = this;\n  this._send('PWD', function(err, text, code) {\n    if (code === 502) {\n      return self.cwd('.', function(cwderr, cwd) {\n        if (cwderr)\n          return cb(cwderr);\n        if (cwd === undefined)\n          cb(err);\n        else\n          cb(undefined, cwd);\n      }, true);\n    } else if (err)\n      return cb(err);\n    cb(undefined, RE_WD.exec(text)[1]);\n  });\n};\n\nFTP.prototype.cdup = function(cb) { // CDUP is optional\n  var self = this;\n  this._send('CDUP', function(err, text, code) {\n    if (code === 502)\n      self.cwd('..', cb, true);\n    else\n      cb(err);\n  });\n};\n\nFTP.prototype.mkdir = function(path, recursive, cb) { // MKD is optional\n  if (typeof recursive === 'function') {\n    cb = recursive;\n    recursive = false;\n  }\n  if (!recursive)\n    this._send('MKD ' + path, cb);\n  else {\n    var self = this, owd, abs, dirs, dirslen, i = -1, searching = true;\n\n    abs = (path[0] === '/');\n\n    var nextDir = function() {\n      if (++i === dirslen) {\n        // return to original working directory\n        return self._send('CWD ' + owd, cb, true);\n      }\n      if (searching) {\n        self._send('CWD ' + dirs[i], function(err, text, code) {\n          if (code === 550) {\n            searching = false;\n            --i;\n          } else if (err) {\n            // return to original working directory\n            return self._send('CWD ' + owd, function() {\n              cb(err);\n            }, true);\n          }\n          nextDir();\n        }, true);\n      } else {\n        self._send('MKD ' + dirs[i], function(err, text, code) {\n          if (err) {\n            // return to original working directory\n            return self._send('CWD ' + owd, function() {\n              cb(err);\n            }, true);\n          }\n          self._send('CWD ' + dirs[i], nextDir, true);\n        }, true);\n      }\n    };\n    this.pwd(function(err, cwd) {\n      if (err)\n        return cb(err);\n      owd = cwd;\n      if (abs)\n        path = path.substr(1);\n      if (path[path.length - 1] === '/')\n        path = path.substring(0, path.length - 1);\n      dirs = path.split('/');\n      dirslen = dirs.length;\n      if (abs)\n        self._send('CWD /', function(err) {\n          if (err)\n            return cb(err);\n          nextDir();\n        }, true);\n      else\n        nextDir();\n    });\n  }\n};\n\nFTP.prototype.rmdir = function(path, recursive, cb) { // RMD is optional\n  if (typeof recursive === 'function') {\n    cb = recursive;\n    recursive = false;\n  }\n  if (!recursive) {\n    return this._send('RMD ' + path, cb);\n  }\n  \n  var self = this;\n  this.list(path, function(err, list) {\n    if (err) return cb(err);\n    var idx = 0;\n    \n    // this function will be called once per listing entry\n    var deleteNextEntry;\n    deleteNextEntry = function(err) {\n      if (err) return cb(err);\n      if (idx >= list.length) {\n        if (list[0] && list[0].name === path) {\n          return cb(null);\n        } else {\n          return self.rmdir(path, cb);\n        }\n      }\n      \n      var entry = list[idx++];\n      \n      // get the path to the file\n      var subpath = null;\n      if (entry.name[0] === '/') {\n        // this will be the case when you call deleteRecursively() and pass\n        // the path to a plain file\n        subpath = entry.name;\n      } else {\n        if (path[path.length - 1] == '/') {\n          subpath = path + entry.name;\n        } else {\n          subpath = path + '/' + entry.name\n        }\n      }\n      \n      // delete the entry (recursively) according to its type\n      if (entry.type === 'd') {\n        if (entry.name === \".\" || entry.name === \"..\") {\n          return deleteNextEntry();\n        }\n        self.rmdir(subpath, true, deleteNextEntry);\n      } else {\n        self.delete(subpath, deleteNextEntry);\n      }\n    }\n    deleteNextEntry();\n  });\n};\n\nFTP.prototype.system = function(cb) { // SYST is optional\n  this._send('SYST', function(err, text) {\n    if (err)\n      return cb(err);\n    cb(undefined, RE_SYST.exec(text)[1]);\n  });\n};\n\n// \"Extended\" (RFC 3659) commands\nFTP.prototype.size = function(path, cb) {\n  var self = this;\n  this._send('SIZE ' + path, function(err, text, code) {\n    if (code === 502) {\n      // Note: this may cause a problem as list() is _appended_ to the queue\n      return self.list(path, function(err, list) {\n        if (err)\n          return cb(err);\n        if (list.length === 1)\n          cb(undefined, list[0].size);\n        else {\n          // path could have been a directory and we got a listing of its\n          // contents, but here we echo the behavior of the real SIZE and\n          // return 'File not found' for directories\n          cb(new Error('File not found'));\n        }\n      }, true);\n    } else if (err)\n      return cb(err);\n    cb(undefined, parseInt(text, 10));\n  });\n};\n\nFTP.prototype.lastMod = function(path, cb) {\n  var self = this;\n  this._send('MDTM ' + path, function(err, text, code) {\n    if (code === 502) {\n      return self.list(path, function(err, list) {\n        if (err)\n          return cb(err);\n        if (list.length === 1)\n          cb(undefined, list[0].date);\n        else\n          cb(new Error('File not found'));\n      }, true);\n    } else if (err)\n      return cb(err);\n    var val = XRegExp.exec(text, REX_TIMEVAL), ret;\n    if (!val)\n      return cb(new Error('Invalid date/time format from server'));\n    ret = new Date(val.year + '-' + val.month + '-' + val.date + 'T' + val.hour\n                   + ':' + val.minute + ':' + val.second);\n    cb(undefined, ret);\n  });\n};\n\nFTP.prototype.restart = function(offset, cb) {\n  this._send('REST ' + offset, cb);\n};\n\n\n\n// Private/Internal methods\nFTP.prototype._pasv = function(cb) {\n  var self = this, first = true, ip, port;\n  this._send('PASV', function reentry(err, text) {\n    if (err)\n      return cb(err);\n\n    self._curReq = undefined;\n\n    if (first) {\n      var m = RE_PASV.exec(text);\n      if (!m)\n        return cb(new Error('Unable to parse PASV server response'));\n      ip = m[1];\n      ip += '.';\n      ip += m[2];\n      ip += '.';\n      ip += m[3];\n      ip += '.';\n      ip += m[4];\n      port = (parseInt(m[5], 10) * 256) + parseInt(m[6], 10);\n\n      first = false;\n    }\n    self._pasvConnect(ip, port, function(err, sock) {\n      if (err) {\n        // try the IP of the control connection if the server was somehow\n        // misconfigured and gave for example a LAN IP instead of WAN IP over\n        // the Internet\n        if (self._socket && ip !== self._socket.remoteAddress) {\n          ip = self._socket.remoteAddress;\n          return reentry();\n        }\n\n        // automatically abort PASV mode\n        self._send('ABOR', function() {\n          cb(err);\n          self._send();\n        }, true);\n\n        return;\n      }\n      cb(undefined, sock);\n      self._send();\n    });\n  });\n};\n\nFTP.prototype._pasvConnect = function(ip, port, cb) {\n  var self = this,\n      socket = new Socket(),\n      sockerr,\n      timedOut = false,\n      timer = setTimeout(function() {\n        timedOut = true;\n        socket.destroy();\n        cb(new Error('Timed out while making data connection'));\n      }, this.options.pasvTimeout);\n\n  socket.setTimeout(0);\n\n  socket.once('connect', function() {\n    self._debug&&self._debug('[connection] PASV socket connected');\n    if (self.options.secure === true) {\n      self.options.secureOptions.socket = socket;\n      self.options.secureOptions.session = self._socket.getSession();\n      //socket.removeAllListeners('error');\n      socket = tls.connect(self.options.secureOptions);\n      //socket.once('error', onerror);\n      socket.setTimeout(0);\n    }\n    clearTimeout(timer);\n    self._pasvSocket = socket;\n    cb(undefined, socket);\n  });\n  socket.once('error', onerror);\n  function onerror(err) {\n    sockerr = err;\n  }\n  socket.once('end', function() {\n    clearTimeout(timer);\n  });\n  socket.once('close', function(had_err) {\n    clearTimeout(timer);\n    if (!self._pasvSocket && !timedOut) {\n      var errmsg = 'Unable to make data connection';\n      if (sockerr) {\n        errmsg += '( ' + sockerr + ')';\n        sockerr = undefined;\n      }\n      cb(new Error(errmsg));\n    }\n    self._pasvSocket = undefined;\n  });\n\n  socket.connect(port, ip);\n};\n\nFTP.prototype._store = function(cmd, input, zcomp, cb) {\n  var isBuffer = Buffer.isBuffer(input);\n\n  if (!isBuffer && input.pause !== undefined)\n    input.pause();\n\n  if (typeof zcomp === 'function') {\n    cb = zcomp;\n    zcomp = false;\n  }\n\n  var self = this;\n  this._pasv(function(err, sock) {\n    if (err)\n      return cb(err);\n\n    if (self._queue[0] && self._queue[0].cmd === 'ABOR') {\n      sock.destroy();\n      return cb();\n    }\n\n    var sockerr, dest = sock;\n    sock.once('error', function(err) {\n      sockerr = err;\n    });\n\n    if (zcomp) {\n      self._send('MODE Z', function(err, text, code) {\n        if (err) {\n          sock.destroy();\n          return cb(makeError(code, 'Compression not supported'));\n        }\n        // draft-preston-ftpext-deflate-04 says min of 8 should be supported\n        dest = zlib.createDeflate({ level: 8 });\n        dest.pipe(sock);\n        sendStore();\n      }, true);\n    } else\n      sendStore();\n\n    function sendStore() {\n      // this callback will be executed multiple times, the first is when server\n      // replies with 150, then a final reply after the data connection closes\n      // to indicate whether the transfer was actually a success or not\n      self._send(cmd, function(err, text, code) {\n        if (sockerr || err) {\n          if (zcomp) {\n            self._send('MODE S', function() {\n              cb(sockerr || err);\n            }, true);\n          } else\n            cb(sockerr || err);\n          return;\n        }\n\n        if (code === 150 || code === 125) {\n          if (isBuffer)\n            dest.end(input);\n          else if (typeof input === 'string') {\n            // check if input is a file path or just string data to store\n            fs.stat(input, function(err, stats) {\n              if (err)\n                dest.end(input);\n              else\n                fs.createReadStream(input).pipe(dest);\n            });\n          } else {\n            input.pipe(dest);\n            input.resume();\n          }\n        } else {\n          if (zcomp)\n            self._send('MODE S', cb, true);\n          else\n            cb();\n        }\n      }, true);\n    }\n  });\n};\n\nFTP.prototype._send = function(cmd, cb, promote) {\n  clearTimeout(this._keepalive);\n  if (cmd !== undefined) {\n    if (promote)\n      this._queue.unshift({ cmd: cmd, cb: cb });\n    else\n      this._queue.push({ cmd: cmd, cb: cb });\n  }\n  var queueLen = this._queue.length;\n  if (!this._curReq && queueLen && this._socket && this._socket.readable) {\n    this._curReq = this._queue.shift();\n    if (this._curReq.cmd === 'ABOR' && this._pasvSocket)\n      this._pasvSocket.aborting = true;\n    this._debug&&this._debug('[connection] > ' + inspect(this._curReq.cmd));\n    this._socket.write(this._curReq.cmd + '\\r\\n');\n  } else if (!this._curReq && !queueLen && this._ending)\n    this._reset();\n};\n\nFTP.prototype._reset = function() {\n  if (this._pasvSock && this._pasvSock.writable)\n    this._pasvSock.end();\n  if (this._socket && this._socket.writable)\n    this._socket.end();\n  this._socket = undefined;\n  this._pasvSock = undefined;\n  this._feat = undefined;\n  this._curReq = undefined;\n  this._secstate = undefined;\n  clearTimeout(this._keepalive);\n  this._keepalive = undefined;\n  this._queue = [];\n  this._ending = false;\n  this._parser = undefined;\n  this.options.host = this.options.port = this.options.user\n                    = this.options.password = this.options.secure\n                    = this.options.connTimeout = this.options.pasvTimeout\n                    = this.options.keepalive = this._debug = undefined;\n  this.connected = false;\n};\n\n// Utility functions\nfunction makeError(code, text) {\n  var err = new Error(text);\n  err.code = code;\n  return err;\n}\n"]},"metadata":{},"sourceType":"script"}